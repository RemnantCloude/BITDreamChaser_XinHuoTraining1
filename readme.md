# 第一届薪火培训电控课件及例程

## 北京理工大学机器人队

培训内容：C51单片机和C语言入门教程

培训时间：2018年9月

## 1 培训介绍&单片机引&Blink

### 1.1 培训形式及教学计划

### 1.2 **C语言** 输入输出

- .c 文件和 .h 文件
  - .h 写类的声明（包括类里面的成员和方法的声明）、结构体、函数原型、#define常数等
  - .c 写main函数和函数定义
- scanf `scanf("%d%d", &a, &b);`
- printf `printf("%d", a+b);`

### 1.3 **C51** 闪烁灯

- 工程建立和配置
  - Project->New uVision Project…
  - Project->Options for Target “Target 1”-> Output -> 勾选Create HEX File，点击OK
- 代码烧录
  - 打开工具与驱动里的STC-ISP
  - 选择单片机型号STC89C52RC/LE52RC、串口号选带有”USB-SERIAL CH340”的那个
  - 选择LED/Objects里的hex文件
  - 点击“下载/编程”
  - 按下电源按钮，关闭电源，再打开

- 等待式延时

```C
void Delay1000ms()  //@11.0592MHz
{
    unsigned char i, j, k;

    i = 8;
    j = 1;
    k = 243;
    do
    {
        do
        {
            while (--k);
        } while (--j);
    } while (--i);
}
```

- 寄存器位操作

```C
sbit led1 = P2^0;
led1 = 0;
```

## 2 数据类型和运算符&流水灯

### 2.1 **补充** 内存

内存(Memory)也被称为内存储器，其作用是用于暂时存放CPU中的运算数据，以及与硬盘等外部存储器交换的数据。只要计算机在运行中，CPU就会把需要运算的数据调到内存中进行运算，当运算完成后CPU再将结果传送出来，内存的运行也决定了计算机的稳定运行。

### 2.2 **C语言** 数据类型和运算符

- 常量
  - 整型 ：100，125，-100，0
  - 实型 ：3.14 ， 0.125，-3.789
  - 字符型 ：‘a’，‘b’，‘2’
  - 字符串：“a”, “ab”， “Hello World”
- 变量
  - 内存是用来存放数据的，变量是给这块内存起的名字，有了变量就可以找到并使用这份数据。
  - 变量必须先定义，后使用
- 符号常量

```C
#define    uint      unsigned int
#define    uchar     unsigned char
#define    TV        “television”
#define    PI        3.1415926
```

- 数据类型 如int, char, float, double, long, unsigned int, unsigned char等
- 强制类型转换 `（类型标识符）表达式`
- 运算符
- 运算符优先级

|    Operators                                     |    PREC    |    ASSO    |
|--------------------------------------------------|------------|------------|
|    ()  [ ]    .   ->                             |    15      |    →       |
|    !  ~    ++  --  - + & *    (type) sizeof()    |    14      |    ←       |
|    *  /  %                                       |    13      |    →       |
|    +  -                                          |    12      |    →       |
|    <<    >>                                      |    11      |    →       |
|    <   <=      >    >=                           |    10      |    →       |
|    ==     !=                                     |    9       |    →       |  
|    &                                             |    8       |    →       |
|    ^                                             |    7       |    →       |
|    `|`                                           |    6       |    →       |
|    &&                                            |    5       |    →       |
|    `||`                                          |    4       |    →       |
|    ?   :                                         |    3       |    ←       |
|    =      op=                                    |    2       |    ←       |
|    ,                                             |    1       |    →       |

- 位运算符

|运算符 |含义   |对象个数   |结合方向   |优先级
| ------| ------   | ------    | ------ | ------
|~      |按位求反   |单目       |右     |1
|<<     |按位左移   |双目       |左      |2
|>>     |按位右移   |双目       |左      |2
|&      |按位与     |双目       |左       |3
|^      |按位异或   |双目       |左       |4
|`|`    |按位或     |双目       |左       |5


### 2.3 **补充** 进制

### 2.4  **C51** 流水灯

- 特殊数据类型
  - sfr:特殊功能寄存器声明
  - sbit:特殊功能位声明
- 寄存器操作
- 移位操作

## 3 控制流程序结构&独立按键

### 3.1 **C语言** 控制流程序结构
  
- 循环语句 for / while / do while

```C
for (secs = 5; secs > 0; secs--)
{
    printf(“%d seconds!\n”  , secs);
}
printf( “We have ignition!\n” );
```

```C
secs=5;
while(secs>0)
{
    printf(“%d seconds!\n”  , secs);
    secs--;
}
printf( “We have ignition!\n” );
```

```C
secs=5;
do
{
    printf(“%d seconds!\n”  , secs);
    secs--;
}while(secs>0)
printf( “We have ignition!\n” );
```

- 条件语句 if else / switch

```C
if(score>=60)
    mood=\^o^/;
else
    mood=T^T;
```

```C
switch(score)
{
    case 59:
        printf(“byebye BIT”);
        break;
    case 61:
        printf(“YEAH”);
        break;
}
```

- 预编译处理
  - 文件包含  将#include指向的文件插入到该行处
  - 条件编译  
    - #if 如果给定条件为真，则编译下面代码
    - #ifdef 如果宏已经定义，则编译下面代码
    - #ifndef 如果宏没有定义，则编译下面代码

### 3.2 **C51** 独立按键

- 按键介绍
  - 弹性按键
    - 按下时闭合松开时自动断开
    - 矩阵键盘上的按键即为此类型
    - 适合做外围输入
  - 自锁按键
    - 按下时闭合并自动锁住
    - 适合做开关
- 按键原理
  - 连接：按键的一端接地，另一端与单片机的某个IO口相连
  - 初始化：IO口赋一高平
  - 检测：当按键闭合时，即相当于该IO口通过按键与地相连，变成低电平，程序一旦检测到1O口变为低电平则说明按键被按下
- 输入捕获，延时去抖
- 矩阵按键
  - 循环查询 在循环中不停地扫描键盘，获取键值
  - 定时查询 基于定时器中断
  - 中断查询 按键按下时触发中断获取键值

## 4 函数和作用域&定时器中断

### 4.1 **C语言** 函数和作用域

- 函数定义

```C
数据类型  函数名(形式参数说明)
{
    说明语句
    执行语句
    return 表达式
}
```

不允许函数嵌套定义；库函数不需要自己定义(I/O函数，数学函数等)

- 变量
  - 存储属性
    - 自动变量(auto)
    - 外部变量(extern)
    - 静态变量(static)
    - 寄存器变量(register)
  - 作用域
    - 局部变量：在函数或复合语句内定义，仅在定义它的函数或  复合语句内有效。（自动变量、内部静态变量、寄存器变量）
    - 全局变量：定义在所有函数之外，作用范围是从定义开始，到本文件或程序结束。（外部变量、外部静态变量）

### 4.2 **C51** 定时器中断

- 定时器

定时器是利用寄存器的功能来实现的，通过硬件来完成，并不影响单片机正常的工作状态。

该寄存器能够进行计数，每经过一个机器周期它的值就会自动+1，当它的值达到了最大值的时候，就会发生溢出，通过识别溢出来进行计时。

- TMOD——定时/计数器模式控制寄存器（不可位寻址）

|    位            |    7         |    6           |    5           |    4     |    3        |    2      |    1     |    0     |
|------------------|--------------|----------------|----------------|----------|-------------|-----------|----------|----------|
|    符号          |    GATE      |    C/T         |    M1          |    M0    |    GATE     |    C/T    |    M1    |    M0    |
|    对应定时器    |    T1        | T1             | T1             | T1       | T0          | T0        | T0       | T0       |
|    描述          |    门控位    |    功能选择    |    工作模式    | 工作模式 |   门控位    | 功能选择  | 工作模式 | 工作模式 |

|    M1    |    M0    |    工作模式    |    描述                                       |
|----------|----------|----------------|-----------------------------------------------|
|    0     |    0     |    0           |    THn的8位和TLn的5位组成13位定时器           |
|    0     |    1     |    1           |    THn和TLn组成16位定时器                     |
|    1     |    0     |    2           |    8位初值自动重装的8位定时器/计数器          |
|    1     |    1     |    3           |    禁用定时器1，将定时器0变成两个8位定时器    |

- TCON——定时器/计数器控制寄存器（可位寻址）

|    位      |    7                  |    6                  |    5                  |    4                  |    3                    |    2                           |    1                    |    0                           |
|------------|-----------------------|-----------------------|-----------------------|-----------------------|-------------------------|--------------------------------|-------------------------|--------------------------------|
|    符号    |    TF1                |    TR1                |    TF0                |    TR0                |    IE1                  |    IT1                         |    IE0                  |    IT0                         |
|    描述    |    定时器1溢出标志    |    定时器1运行控制    |    定时器0溢出标志    |    定时器0运行控制    |    外部中断1请求标志    |    外部中断1   触发方式选择    |    外部中断0请求标志    |    外部中断0   触发方式选择    |

TF1：当定时器1溢出时，TF1自动置1。若响应中断，TF1自动清零。也可用软件清零。

TR1：置1启动定时器1，置0关闭定时器1。

TF0：当定时器0溢出时，TF0自动置1 。若响应中断，TF0自动清零。也可用软件清零。

TR0：置1启动定时器0，置0关闭定时器0 。


- 时钟周期

时钟周期是单片机中最小的时间单位。时钟周期 = 1/外部晶振频率          T=1/12MHz

- 机器周期

机器周期是单片机完成一个操作的最短时间。

机器周期 = 1/单片机的时钟频率。

51单片机内部时钟频率是外部晶振频率的12分频。

一个机器周期是12个时钟周期。

机器周期 = 12/(12MHz)=1us

- 中断

CPU在处理某一事件A时，发生了另一事件B请求CPU迅速去处理(中断发生)；CPU暂时中断当前的工作，转去处理事件B(中断响应和中断服务)；待CPU将事件B处理完毕后，再回到原来事件A被中断的地方继续处理事件A（中断返回），这一过程称为中断 。

1.外部中断：中断引脚接收到了电平变化或者产生负跳变时触发。

2.定时器中断：定时器产生溢出时触发中断。

3.串口中断：用于串口通信。

- IE——中断使能寄存器（可位寻址）

|    位      |    7             |    6    |    5    |    4               |    3                  |    2                |    1                  |    0                |
|------------|------------------|---------|---------|--------------------|-----------------------|---------------------|-----------------------|---------------------|
|    符号    |    EA            |    -    |    -    |    ES              |    ET1                |    EX1              |    ET0                |    EX0              |
|    描述    |    总中断使能    |         |         |    串口中断使能    |    定时器1中断使能    |    外部中断1使能    |    定时器0中断使能    |    外部中断0使能    |

IP——中断优先级控制寄存器（可位寻址）
|    位      |    7    |    6    |    5                            |    4                   |    3                            |    2                        |    1                            |    0                        |
|------------|---------|---------|---------------------------------|------------------------|---------------------------------|-----------------------------|---------------------------------|-----------------------------|
|    符号    |    -    |    -    |    PT2                          |    PS                  |    PT1                          |    PX1                      |    PT0                          |    PX0                      |
|    描述    |         |         |    定时/计数器T2优先级设定位    |    串口优先级设定位    |    定时/计数器T1优先级设定位    |    外部中断1优先级设定位    |    定时/计数器T0优先级设定位    |    外部中断0优先级设定位    |
51单片机的中断系统有2个优先级层次，当某一位被置1时该中断设为高优先级，置0则为低优先级。

- 中断函数编号x

|    中断函数编号    |    中断名称       |    中断标志位    |    中断引起原因                      |    默认优先级    |
|--------------------|-------------------|------------------|--------------------------------------|------------------|
|    0               |    外部中断0      |    IE0           |    P3.2引脚低电平或下降沿信号        |    1（最高）     |
|    1               |    定时器0中断    |    TF0           |    定时器0溢出                       |    2             |
|    2               |    外部中断1      |    IE1           |    P3.3引脚低电平或下降沿信号        |    3             |
|    3               |    定时器1中断    |    TF1           |    定时器1溢出                       |    4             |
|    4               |    串口中断       |    TI/RI         |    串行通信完成一帧数据发送或接收    |    5             |

- 51单片机的中断优先级有三条原则：
  - CPU同时接收到几个中断时，首先响应优先级别最高的中断请求。
  - 正在进行的中断过程不能被新的同级或低优先级的中断请求所中断。
  - 正在进行的低优先级中断服务，能被高优先级中断请求所中断。

## 6 数组和指针&数码管

### 6.1 **C语言** 数组、字符串和指针

- 数组 `数据类型  数组名[常量表达式]`
  - 1.数组元素的下标一律从0开始下标，不能越界
  - 2.数组大小必须是正数、常量，不能为变量
  - 3.数组大小最好宏定义，以适应未来可能的变化
- 数组初始化

```C
一般方法：int a[10]={1,2,3,4,5,6,7,8,9,10};
初始化部分元素:float x[5] = { 1.9, 2.0 }; 
根据数据定义数组长度:  int b[ ] = {1, 2, 3, 4};
```

- 字符串数组

```C
char ch[6]={"CHINA"};
char ch[6]="CHINA";	      /* 省略 { } */
char ch[] ="CHINA";  	/* 省略长度值 */
```

- 字符串函数

```C
#include<string.h> 
获得串长    len=strlen(str);  
字符串复制    strcpy(str1,str2);  //注：将2复制到1中
字符串比较    strcmp(str1,str2);  //0相等;正数str1大;负数str2大
字符串输入输出    gets(str);puts(str);
字符串连接    strcat(str1,str2);  
字符串大写转换 strupr(str);
字符串小写转换 strlwr(str);
```

- 指针
  - & 取地址运算符
  - `*` 指针内容运算符

### 6.2 **C51** 数码管

- 数码管

## 7 枚举-结构类型&PWM呼吸灯

### 7.1 **C语言** 枚举-结构类型

- 结构体

```C
struct Book
{
      char title[50]; 
      char author[50];
      char subject[100];
      int book_id;
}
```

- 枚举类型 `enum　枚举名　{枚举元素1,枚举元素2,……};`

### 7.2 **C51** PWM呼吸灯

- PWM

脉冲宽度调制（PWM），是英文“Pulse Width Modulation”的缩写，简称脉宽调试。是利用微处理器的数字输出来对模拟电路进行控制的一种非常有效的技术。广泛应用在从测量、通信到功率控制与变换的许多领域中。

## 8 标准函数库&串口数据包传送

### 8.1 **C语言** 标准函数库

- 函数

```C
<stdio.h> 
sscanf

<stdlib.h> 
qsort

<string.h>
strlen
```

### 8.2 **C51** 串口数据包传送

- 串口通信协议
  - 起始位：先发出一个逻辑”0”的信号，表示传输字符的开始。
  - 资料位：紧接着起始位之后。资料位的个数可以是4、5、6、7、8等，构成一个字符。通常采用ASCII码。从最低位开始传送，靠时钟定位。
  - 奇偶校验位：资料位加上这一位后，使得“1”的位数应为偶数(偶校验)或奇数(奇校验)，以此来校验资料传送的正确性。
  - 停止位：它是一个字符数据的结束标志。可以是1位、1.5位、2位的高电平。 由于数据是在传输线上定时的，并且每一个设备有其自己的时钟，很可能在通信中两台设备间出现了小小的不同步。因此停止位不仅仅是表示传输的结束，并且提供计算机校正时钟同步的机会。适用于停止位的位数越多，不同时钟同步的容忍程度越大，但是数据传输率同时也越慢。 
  - 空闲位：处于逻辑“1”状态，表示当前线路上没有资料传送。
  - 波特率：是衡量资料传送速率的指标。表示每秒钟传送的符号数（symbol）。一个符号代表的信息量（比特数）与符号的阶数有关。例如资料传送速率为120字符/秒，传输使用256阶符号，每个符号代表8bit，则波特率就是120baud，比特率是120*8=960bit/s。这两者的概念很容易搞错。
- 串口的控制寄存器（SCON）及串行口的工作方式
